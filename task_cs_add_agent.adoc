---
sidebar: sidebar 
permalink: task_cs_add_agent.html 
keywords: agent, Workload Security, installation, Cloud Secure 
summary: Implemente agentes de seguridad de carga de trabajo para monitorear la actividad del usuario, detectar amenazas de seguridad y proteger su infraestructura de almacenamiento. 
---
= Implementar agentes de seguridad de carga de trabajo
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
Los agentes de seguridad de carga de trabajo son esenciales para monitorear la actividad del usuario y detectar posibles amenazas a la seguridad en su infraestructura de almacenamiento. Esta guía proporciona instrucciones de instalación paso a paso, mejores prácticas para la gestión de agentes (incluidas capacidades de pausa/reanudación y fijación/desfijación) y requisitos de configuración posteriores a la implementación. Antes de comenzar, asegúrese de que su servidor de agente cumpla con los link:concept_cs_agent_requirements.html["Requisitos del sistema"].



== Antes de empezar

* El privilegio sudo es necesario para la instalación, la ejecución de scripts y la desinstalación.
* Durante la instalación del agente, se crean un usuario local _cssys_ y un grupo local _cssys_ en la máquina.  Si la configuración de permisos no permite la creación de un usuario local y en su lugar requiere Active Directory, se debe crear un usuario con el nombre de usuario _cssys_ en el servidor de Active Directory.
* Puede leer sobre la seguridad de Data Infrastructure Insightslink:security_overview.html["aquí"] .




== Mejores prácticas

Tenga en cuenta lo siguiente antes de configurar su agente de seguridad de carga de trabajo.

[cols="1,3"]
|===


| Pausa y reanudar | Pausa: Elimina fpolicies de ONTAP. Se suele utilizar cuando los clientes realizan actividades de mantenimiento prolongadas que pueden llevar mucho tiempo, como reinicios de máquinas virtuales de agentes o reemplazos de almacenamiento. Resumen: Se vuelven a agregar las políticas fpolicies a ONTAP. 


| Anclar y desanclar | Unpin descarga inmediatamente la última versión (si está disponible) y actualiza el agente y el recopilador. Durante esta actualización, fpolicies se desconectará y volverá a conectarse. Esta función está diseñada para clientes que desean controlar el momento de las actualizaciones automáticas. Véase más abajo para<<pinning-an-agent-at-the-current-version,Instrucciones para fijar/desfijar>> . 


| Enfoque recomendado | Para configuraciones grandes, es recomendable usar Pin y Unpin en lugar de pausar los colectores. No es necesario pausar ni reanudar la actividad al usar las funciones de fijar y desfijar. Los clientes pueden mantener sus agentes y recopiladores vinculados y, al recibir una notificación por correo electrónico sobre una nueva versión, disponen de un plazo de 30 días para actualizar selectivamente los agentes uno por uno. Este enfoque minimiza el impacto de la latencia en las políticas de fpolicies y proporciona un mayor control sobre el proceso de actualización. 
|===


== Pasos para instalar el agente

. Inicie sesión como administrador o propietario de cuenta en su entorno de seguridad de carga de trabajo.
. Seleccione *Coleccionistas > Agentes > +Agente*
+
El sistema muestra la página Agregar un agente:

+
image::Add-agent-1.png[Agregar un agente de seguridad de carga de trabajo]

. Verifique que el servidor del agente cumpla con los requisitos mínimos del sistema.
. Para verificar que el servidor del agente esté ejecutando una versión compatible de Linux, haga clic en _Versiones compatibles (i)_.
. Si su red utiliza un servidor proxy, configure los detalles del servidor proxy siguiendo las instrucciones en la sección Proxy.
+
image:CloudSecureAgentWithProxy_Instructions.png["Nota sobre la instalación del agente con proxy"]

. Haga clic en el icono Copiar al portapapeles para copiar el comando de instalación.
. Ejecute el comando de instalación en una ventana de terminal.
. El sistema muestra el siguiente mensaje cuando la instalación se completa correctamente:
+
image::new-agent-detect.png[Mensaje de instalación exitosa del agente]



.Después de terminar
. Necesitas configurar unlink:task_config_user_dir_connect.html["Recopilador de directorios de usuarios"] .
. Necesita configurar uno o más recopiladores de datos.




== Configuración de red

Ejecute los siguientes comandos en el sistema local para abrir los puertos que utilizará Workload Security.  Si existe un problema de seguridad con respecto al rango de puertos, puede utilizar un rango de puertos menor, por ejemplo _35000:35100_.  Cada SVM utiliza dos puertos.

.Pasos
. `sudo firewall-cmd --permanent --zone=public --add-port=35000-55000/tcp`
. `sudo firewall-cmd --reload`


Sigue los siguientes pasos según tu plataforma:

*CentOS 7.x / RHEL 7.x*:

. `sudo iptables-save | grep 35000`


Salida de muestra:

 -A IN_public_allow -p tcp -m tcp --dport 35000:55000 -m conntrack -ctstate NEW,UNTRACKED -j ACCEPT
*CentOS 8.x / RHEL 8.x*:

. `sudo firewall-cmd --zone=public --list-ports | grep 35000`(para CentOS 8)


Salida de muestra:

 35000-55000/tcp


== "Fijar" un agente en la versión actual

De forma predeterminada, Data Infrastructure Insights Workload Security actualiza los agentes automáticamente.  Es posible que algunos clientes deseen pausar la actualización automática, lo que deja al Agente en su versión actual hasta que ocurra una de las siguientes situaciones:

* El cliente reanuda las actualizaciones automáticas del Agente.
* Han pasado 30 días.  Tenga en cuenta que los 30 días comienzan el día de la actualización más reciente del Agente, no el día en que se pausa el Agente.


En cada uno de estos casos, el agente se actualizará en la próxima actualización de Seguridad de carga de trabajo.

Para pausar o reanudar las actualizaciones automáticas del agente, utilice las API _cloudsecure_config.agents_:

image:ws_pin_agent_apis.png["API de agente de CloudSecure para fijar y desanclar agentes"]

Tenga en cuenta que la acción de pausar o reanudar puede tardar hasta cinco minutos en surtir efecto.

Puede ver las versiones actuales de su Agente en la página *Seguridad de carga de trabajo > Recopiladores*, en la pestaña *Agentes*.

image:ws_agent_version.png["Versiones de WS Agent que se muestran en la tabla de agentes"]



== Solución de problemas de errores del agente

Los problemas conocidos y sus resoluciones se describen en la siguiente tabla.

[cols="2*"]
|===
| Problema: | Resolución: 


| La instalación del agente no logra crear la carpeta /opt/netapp/cloudsecure/agent/logs/agent.log y el archivo install.log no proporciona información relevante. | Este error se produce durante el arranque del agente.  El error no se registra en los archivos de registro porque ocurre antes de que se inicialice el registrador.  El error se redirige a la salida estándar y es visible en el registro de servicio mediante el `journalctl -u cloudsecure-agent.service` dominio.  Este comando se puede utilizar para solucionar el problema con más detalle. 


| La instalación del agente falla con el mensaje 'Esta distribución de Linux no es compatible'.  Saliendo de la instalación'. | Este error aparece cuando intenta instalar el Agente en un sistema no compatible. Ver link:concept_cs_agent_requirements.html["Requisitos del agente"] . 


| La instalación del agente falló con el error: "-bash: unzip: comando no encontrado" | Instale, descomprima y luego ejecute el comando de instalación nuevamente.  Si Yum está instalado en la máquina, intente “yum install unzip” para instalar el software de descompresión.  Después de eso, vuelva a copiar el comando desde la interfaz de usuario de instalación del Agente y péguelo en la CLI para ejecutar la instalación nuevamente. 


| El agente se instaló y estaba ejecutándose.  Sin embargo, el agente se detuvo de repente. | SSH a la máquina del agente.  Verifique el estado del servicio del agente a través de `sudo systemctl status cloudsecure-agent.service` . 1.  Compruebe si los registros muestran el mensaje “Error al iniciar el servicio de demonio de seguridad de carga de trabajo”. 2.  Verifique si el usuario cssys existe en la máquina del Agente o no.  Ejecute los siguientes comandos uno por uno con permiso de root y verifique si el usuario y el grupo cssys existen.
`sudo id cssys`
`sudo groups cssys` 3.  Si no existe ninguno, es posible que una política de monitoreo centralizada haya eliminado el usuario cssys. 4.  Cree un usuario y un grupo cssys manualmente ejecutando los siguientes comandos.
`sudo useradd cssys`
`sudo groupadd cssys` 5.  Luego reinicie el servicio del agente ejecutando el siguiente comando:
`sudo systemctl restart cloudsecure-agent.service` 6.  Si aún no funciona, verifique las otras opciones de solución de problemas. 


| No se pueden agregar más de 50 recopiladores de datos a un agente. | Sólo se pueden agregar 50 recopiladores de datos a un agente.  Puede ser una combinación de todos los tipos de recopiladores, por ejemplo, Active Directory, SVM y otros recopiladores. 


| La interfaz de usuario muestra que el agente está en estado NO CONECTADO. | Pasos para reiniciar el Agente. 1.  SSH a la máquina del agente. 2.  Luego reinicie el servicio del agente ejecutando el siguiente comando:
`sudo systemctl restart cloudsecure-agent.service` 3.  Verifique el estado del servicio del agente a través de `sudo systemctl status cloudsecure-agent.service` . 4.  El agente debe pasar al estado CONECTADO. 


| La máquina virtual del agente está detrás del proxy Zscaler y la instalación del agente está fallando.  Debido a la inspección SSL del proxy Zscaler, los certificados de seguridad de carga de trabajo se presentan como si estuvieran firmados por Zscaler CA, por lo que el agente no confía en la comunicación. | Deshabilite la inspección SSL en el proxy Zscaler para la URL *.cloudinsights.netapp.com.  Si Zscaler realiza una inspección SSL y reemplaza los certificados, Workload Security no funcionará. 


| Al instalar el agente, la instalación se bloquea después de descomprimirlo. | El comando “chmod 755 -Rf” está fallando.  El comando falla cuando el comando de instalación del agente lo ejecuta un usuario sudo que no es root y que tiene archivos en el directorio de trabajo que pertenecen a otro usuario y no se pueden cambiar los permisos de esos archivos.  Debido a la falla del comando chmod, el resto de la instalación no se ejecuta. 1.  Cree un nuevo directorio llamado “cloudsecure”. 2.  Vaya a ese directorio. 3.  Copie y pegue el comando de instalación completo “token=…… … ./cloudsecure-agent-install.sh" y presione Enter. 4.  La instalación debería poder continuar. 


| Si el agente aún no puede conectarse a Saas, abra un caso con el soporte de NetApp .  Proporcione el número de serie de Data Infrastructure Insights para abrir un caso y adjunte registros al caso como se indica. | Para adjuntar registros al estuche: 1.  Ejecute el siguiente script con permiso de root y comparta el archivo de salida (cloudsecure-agent-symptoms.zip). a. /opt/netapp/cloudsecure/agent/bin/cloudsecure-agent-symptom-collector.sh 2.  Ejecute los siguientes comandos uno por uno con permiso de root y comparta la salida. a. id cssys b. groups cssys c. cat /etc/os-release 


| El script cloudsecure-agent-symptom-collector.sh falla con el siguiente error.  [root@machine tmp]# /opt/netapp/cloudsecure/agent/bin/cloudsecure-agent-symptom-collector.sh Recopilación de registro de servicio Recopilación de registros de aplicaciones Recopilación de configuraciones de agente Toma de instantánea del estado del servicio Toma de instantánea de la estructura del directorio del agente ………………….  ………………….  /opt/netapp/cloudsecure/agent/bin/cloudsecure-agent-symptom-collector.sh: línea 52: zip: comando no encontrado ERROR: No se pudo crear /tmp/cloudsecure-agent-symptoms.zip | La herramienta Zip no está instalada.  Instale la herramienta zip ejecutando el comando “yum install zip”.  Luego ejecute cloudsecure-agent-symptom-collector.sh nuevamente. 


| La instalación del agente falla con useradd: no se puede crear el directorio /home/cssys | Este error puede ocurrir si el directorio de inicio de sesión del usuario no se puede crear en /home, debido a la falta de permisos.  La solución alternativa sería crear un usuario cssys y agregar su directorio de inicio de sesión manualmente usando el siguiente comando: _sudo useradd user_name -m -d HOME_DIR_ -m: Crea el directorio de inicio del usuario si no existe.  -d: El nuevo usuario se crea utilizando HOME_DIR como valor para el directorio de inicio de sesión del usuario.  Por ejemplo, _sudo useradd cssys -m -d /cssys_, agrega un usuario _cssys_ y crea su directorio de inicio de sesión bajo la raíz. 


| El agente no se ejecuta después de la instalación.  _Systemctl status cloudsecure-agent.service_ muestra lo siguiente: [root@demo ~]# systemctl status cloudsecure-agent.service agent.service – Servicio Daemon del agente de seguridad de carga de trabajo Cargado: cargado (/usr/lib/systemd/system/cloudsecure-agent.service; habilitado; valor predeterminado del proveedor: deshabilitado) Activo: activando (reinicio automático) (Resultado: código de salida) desde el martes 2021-08-03 21:12:26 PDT; Hace 2 s Proceso: 25889 ExecStart=/bin/bash /opt/netapp/cloudsecure/agent/bin/cloudsecure-agent (código=salido estado=126) PID principal: 25889 (código=salido, estado=126), 03 ago 21:12:26 demo systemd[1]: cloudsecure-agent.service: proceso principal salió, código=salido, estado=126/n/a 03 ago 21:12:26 demo systemd[1]: La unidad cloudsecure-agent.service entró en estado de error.  03 de agosto 21:12:26 demo systemd[1]: cloudsecure-agent.service falló. | Esto puede fallar porque el usuario _cssys_ podría no tener permiso para instalar.  Si /opt/netapp es un montaje NFS y el usuario _cssys_ no tiene acceso a esta carpeta, la instalación fallará.  _cssys_ es un usuario local creado por el instalador de Workload Security que puede no tener permiso para acceder al recurso compartido montado.  Puede comprobarlo intentando acceder a /opt/netapp/cloudsecure/agent/bin/cloudsecure-agent usando el usuario _cssys_.  Si devuelve “Permiso denegado”, el permiso de instalación no está presente.  En lugar de una carpeta montada, instálelo en un directorio local de la máquina. 


| El agente se conectó inicialmente a través de un servidor proxy y el proxy se configuró durante la instalación del agente.  Ahora el servidor proxy ha cambiado.  ¿Cómo se puede cambiar la configuración del proxy del Agente? | Puede editar agent.properties para agregar los detalles del proxy.  Siga estos pasos: 1.  Cambie a la carpeta que contiene el archivo de propiedades: cd /opt/netapp/cloudsecure/conf 2.  Usando su editor de texto favorito, abra el archivo _agent.properties_ para editarlo. 3.  Agregue o modifique las siguientes líneas: AGENT_PROXY_HOST=scspa1950329001.vm.netapp.com AGENT_PROXY_PORT=80 AGENT_PROXY_USER=pxuser AGENT_PROXY_PASSWORD=pass1234 4.  Guarde el archivo. 5.  Reinicie el agente: sudo systemctl restart cloudsecure-agent.service 
|===